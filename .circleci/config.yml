version: 2.1

executors:
  node-18:
    docker:
      - image: cimg/node:18.20
    working_directory: ~/project
  node-20:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project

commands:
  setup:
    description: "Checkout, enable corepack, and install dependencies"
    steps:
      - checkout
      - run:
          name: Enable corepack
          command: corepack enable
      - restore_cache:
          keys:
            - v1-pnpm-store-{{ checksum "pnpm-lock.yaml" }}
            - v1-pnpm-store-
      - run:
          name: Install dependencies
          command: pnpm install --frozen-lockfile
      - save_cache:
          key: v1-pnpm-store-{{ checksum "pnpm-lock.yaml" }}
          paths:
            - ~/.local/share/pnpm/store

jobs:
  lint:
    executor: node-20
    steps:
      - setup
      - run:
          name: Lint
          command: pnpm lint

  build-and-test:
    parameters:
      executor:
        type: executor
    executor: << parameters.executor >>
    steps:
      - setup
      - run:
          name: Build
          command: pnpm build
      - run:
          name: Test
          command: pnpm test

workflows:
  ci:
    jobs:
      - lint
      - build-and-test:
          name: build-and-test-node-18
          executor: node-18
      - build-and-test:
          name: build-and-test-node-20
          executor: node-20
